<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>rust-mule::node_stats</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="/ui/assets/js/theme-init.js"></script>
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="/ui/assets/css/layout.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="/ui/assets/css/typography.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="/ui/assets/css/color-hc.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="/ui/assets/css/colors-light.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="/ui/assets/css/color-dark.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="/ui/assets/css/base.css"
    />
    <script defer src="/ui/assets/js/alpine.min.js"></script>
    <script defer src="/ui/assets/js/chart.min.js"></script>
    <script type="module" src="/ui/assets/js/app.js"></script>
  </head>

  <body x-data="appNodeStats()" x-init="init()">
    <section class="container shell">
      <aside class="card sidebar">
        <h2>rust-mule</h2>
        <p>Search dashboard shell</p>

        <h3 class="mt-4">Navigation</h3>
        <ul class="nav-list mt-3">
          <li><a href="/ui">Overview</a></li>
          <li><a href="/ui/search">Searches</a></li>
          <li><a href="/ui/node_stats">Nodes / Routing</a></li>
          <li><a href="/ui/log">Logs</a></li>
          <li><a href="/ui/settings">Settings</a></li>
        </ul>

        <h3 class="mt-4">Search Threads</h3>
        <ul class="search-list mt-3">
          <template x-if="searchThreads.length === 0">
            <li class="search-item">
              <small>No active keyword searches yet.</small>
            </li>
          </template>
          <template x-for="thread in searchThreads" :key="thread.search_id_hex">
            <li class="search-item">
              <div class="flex gap-3 flex-wrap">
                <a
                  x-bind:href="'/ui/search_details?searchId=' + thread.search_id_hex"
                >
                  <strong x-text="thread.search_id_hex"></strong>
                </a>
                <span
                  class="badge"
                  x-bind:class="thread.state_class"
                  x-text="thread.state"
                ></span>
              </div>
              <small>
                hits: <span x-text="thread.hits"></span> Â· age:
                <span x-text="thread.created_secs_ago"></span>s
              </small>
            </li>
          </template>
        </ul>
      </aside>

      <main class="main-scroll grid gap-4">
        <div class="card">
          <div class="flex gap-3 flex-wrap">
            <h1>Node Stats</h1>
            <span
              class="badge"
              x-text="connected ? 'sse: connected' : 'sse: disconnected'"
            ></span>
            <button
              class="btn ml-auto"
              type="button"
              @click="refresh()"
              x-bind:disabled="loading"
            >
              Refresh
            </button>
          </div>
          <p class="mt-3" x-show="error" x-text="error"></p>
        </div>

        <div class="card">
          <div class="flex gap-3 flex-wrap">
            <h2>Chart Controls</h2>
            <button
              class="btn ml-auto"
              type="button"
              @click="toggleHistoryPause()"
            >
              <span
                x-text="historyPaused ? 'Resume Charts' : 'Pause Charts'"
              ></span>
            </button>
            <button class="btn" type="button" @click="resetHistory()">
              Reset History
            </button>
          </div>
          <div class="field mt-3">
            <label for="chart-window">Time Window (samples)</label>
            <select
              id="chart-window"
              class="input"
              x-model.number="historyWindow"
              @change="updateCharts()"
            >
              <template x-for="n in historyWindows" :key="n">
                <option :value="n" x-text="n"></option>
              </template>
            </select>
          </div>
        </div>

        <div class="grid grid-3">
          <div class="card">
            <div class="kpi" x-text="status?.routing ?? totalNodes"></div>
            <span class="label">Routing Nodes</span>
          </div>
          <div class="card">
            <div class="kpi" x-text="liveNodes"></div>
            <span class="label">Live Nodes (seen <= 10m)</span>
          </div>
          <div class="card">
            <div class="kpi" x-text="activeNodes"></div>
            <span class="label">Active Nodes (inbound <= 10m)</span>
          </div>
        </div>

        <div class="grid grid-3">
          <div class="card">
            <h2>Search Hits Over Time</h2>
            <p class="mt-3">
              Total active-search hits observed in each sample.
            </p>
            <div class="chart-wrap mt-3">
              <canvas x-ref="hitsChart"></canvas>
            </div>
          </div>
          <div class="card">
            <h2>Traffic Rate</h2>
            <p class="mt-3">
              Requests/sec vs responses/sec from status counters.
            </p>
            <div class="chart-wrap mt-3">
              <canvas x-ref="rateChart"></canvas>
            </div>
          </div>
          <div class="card">
            <h2>Peer State Mix</h2>
            <p class="mt-3">Live and idle peers over time.</p>
            <div class="chart-wrap mt-3">
              <canvas x-ref="peersChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Known Nodes</h2>
          <table class="table mt-3">
            <thead>
              <tr>
                <th>State</th>
                <th>Kad ID</th>
                <th>Kad Ver</th>
                <th>Seen</th>
                <th>Inbound</th>
                <th>Failures</th>
              </tr>
            </thead>
            <tbody>
              <template x-if="peers.length === 0">
                <tr>
                  <td colspan="6">No nodes available yet.</td>
                </tr>
              </template>
              <template x-for="peer in peers" :key="peer.kad_id_hex">
                <tr>
                  <td>
                    <span
                      class="badge"
                      x-bind:class="peer.ui_state_class"
                      x-text="peer.ui_state"
                    ></span>
                  </td>
                  <td><code x-text="peer.kad_id_hex"></code></td>
                  <td x-text="peer.kad_version"></td>
                  <td><span x-text="peer.last_seen_secs_ago"></span>s</td>
                  <td>
                    <span x-text="peer.inbound_label"></span>
                  </td>
                  <td x-text="peer.failures"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </main>
    </section>
  </body>
</html>
