<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>rust-mule::settings</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="/ui/assets/js/theme-init.js"></script>
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="/ui/assets/css/layout.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="/ui/assets/css/typography.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="/ui/assets/css/color-hc.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="/ui/assets/css/colors-light.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="/ui/assets/css/color-dark.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      media="screen"
      href="/ui/assets/css/base.css"
    />
    <script defer src="/ui/assets/js/alpine.min.js"></script>
    <script type="module" src="/ui/assets/js/app.js"></script>
  </head>

  <body x-data="appSettings()" x-init="init()">
    <section class="container shell">
      <aside class="card sidebar">
        <h2>rust-mule</h2>
        <p>Search dashboard shell</p>
        <div class="flex gap-2 flex-wrap mt-3">
          <span
            class="badge"
            x-bind:class="sessionStateClass"
            x-text="sessionStateLabel"
          ></span>
          <button
            class="btn"
            type="button"
            @click="checkSession()"
            x-bind:disabled="sessionChecking"
          >
            Check
          </button>
          <button class="btn" type="button" @click="logoutSession()">
            Logout
          </button>
        </div>

        <h3 class="mt-4">Navigation</h3>
        <ul class="nav-list mt-3">
          <li><a href="/ui">Overview</a></li>
          <li><a href="/ui/search">Searches</a></li>
          <li><a href="/ui/node_stats">Nodes / Routing</a></li>
          <li><a href="/ui/log">Logs</a></li>
          <li><a href="/ui/settings">Settings</a></li>
        </ul>

        <h3 class="mt-4">Search Threads</h3>
        <ul class="search-list mt-3">
          <template x-if="searchThreads.length === 0">
            <li class="search-item">
              <small>No active keyword searches yet.</small>
            </li>
          </template>
          <template x-for="thread in searchThreads" :key="thread.search_id_hex">
            <li class="search-item">
              <div class="flex gap-3 flex-wrap">
                <a
                  x-bind:href="'/ui/search_details?searchId=' + thread.search_id_hex"
                >
                  <strong x-text="thread.search_id_hex"></strong>
                </a>
                <span
                  class="badge"
                  x-bind:class="thread.state_class"
                  x-text="thread.state"
                ></span>
              </div>
              <small>
                hits: <span x-text="thread.hits"></span> Â· age:
                <span x-text="thread.created_secs_ago"></span>s
              </small>
            </li>
          </template>
        </ul>
      </aside>

      <main class="main-scroll grid gap-4">
        <div class="card">
          <h1>Settings</h1>
          <p>
            Configure runtime settings persisted to <code>config.toml</code>.
          </p>
          <div class="flex gap-3 flex-wrap mt-3">
            <button class="btn" type="button" @click="rotateApiToken()">
              Rotate API Token
            </button>
          </div>
          <p class="mt-3" x-show="error" x-text="error"></p>
          <p class="mt-3" x-show="notice" x-text="notice"></p>
        </div>

        <div class="card">
          <h2>Theme</h2>
          <div class="field mt-3">
            <label for="theme-selector">Color Theme</label>
            <select
              id="theme-selector"
              class="input"
              x-model="theme"
              @change="applyTheme()"
            >
              <option value="dark">Dark</option>
              <option value="light">Light</option>
              <option value="hc">High Contrast</option>
            </select>
          </div>
          <p class="mt-3">
            Active theme: <span class="badge" x-text="theme"></span>
          </p>
        </div>

        <div class="grid grid-2">
          <div class="card">
            <div class="kpi" x-text="searchThreads.length"></div>
            <span class="label">Active Search Threads</span>
          </div>
          <div class="card">
            <div class="kpi" x-text="status?.routing ?? 0"></div>
            <span class="label">Routing Nodes</span>
          </div>
        </div>

        <div class="card">
          <h2>Application Settings</h2>
          <form class="form-grid mt-3" @submit.prevent="saveSettings()">
            <div class="field">
              <label for="sam-host">SAM Host</label>
              <input
                id="sam-host"
                class="input"
                type="text"
                x-model="form.samHost"
              />
            </div>
            <div class="field">
              <label for="sam-port">SAM Port</label>
              <input
                id="sam-port"
                class="input"
                type="number"
                min="1"
                max="65535"
                x-model.number="form.samPort"
              />
            </div>
            <div class="field">
              <label for="sam-session">SAM Session Name</label>
              <input
                id="sam-session"
                class="input"
                type="text"
                x-model="form.samSessionName"
              />
            </div>
            <div class="field">
              <label for="api-host">API Host</label>
              <input
                id="api-host"
                class="input"
                type="text"
                x-model="form.apiHost"
              />
            </div>
            <div class="field">
              <label for="api-port">API Port</label>
              <input
                id="api-port"
                class="input"
                type="number"
                min="1"
                max="65535"
                x-model.number="form.apiPort"
              />
            </div>
            <div class="field">
              <label for="log-level">Console Log Filter</label>
              <input
                id="log-level"
                class="input"
                type="text"
                x-model="form.logLevel"
              />
            </div>
            <div class="field">
              <label for="log-file-level">File Log Filter</label>
              <input
                id="log-file-level"
                class="input"
                type="text"
                x-model="form.logFileLevel"
              />
            </div>
            <div class="field">
              <label for="log-to-file">Log To File</label>
              <select id="log-to-file" class="input" x-model="form.logToFile">
                <option :value="true">Enabled</option>
                <option :value="false">Disabled</option>
              </select>
            </div>
            <div class="flex gap-3 flex-wrap">
              <button
                class="btn btn-primary"
                type="submit"
                x-bind:disabled="saving || loading"
              >
                <span x-text="saving ? 'Saving...' : 'Save Settings'"></span>
              </button>
              <button
                class="btn"
                type="button"
                x-bind:disabled="saving || loading"
                @click="loadSettings()"
              >
                Reload
              </button>
            </div>
          </form>
          <p class="mt-3" x-show="restartRequired">
            Changes may require process restart to fully apply.
          </p>
        </div>

        <div class="card">
          <h2>Runtime Snapshot</h2>
          <pre class="log" x-text="prettyStatus"></pre>
        </div>
      </main>
    </section>
  </body>
</html>
